# é’‰é’‰ç™»å½•é—®é¢˜è¯¦ç»†è¯Šæ–­æŒ‡å—

## ğŸ” å½“å‰çŠ¶æ€

æ ¹æ®æ‚¨æä¾›çš„ä¿¡æ¯ï¼š
- âœ… ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- âœ… æˆæƒURLç”Ÿæˆæ­£ç¡®
- âœ… é’‰é’‰å¼€æ”¾å¹³å°å›è°ƒåœ°å€å·²é…ç½®
- âœ… å®‰å…¨åŸŸåå·²æ·»åŠ 
- âŒ ä»ç„¶å‡ºç°"urlå‚æ•°ä¸åˆæ³•"é”™è¯¯

## ğŸ“‹ è¯¦ç»†è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1ï¼šé‡æ–°æ„å»ºåç«¯å¹¶æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```bash
# 1. é‡æ–°æ„å»ºåç«¯ï¼ˆä½¿ç”¨æœ€æ–°ä»£ç ï¼‰
docker-compose down
docker-compose build --no-cache api
docker-compose up -d

# 2. ç­‰å¾…å¯åŠ¨å®Œæˆ
sleep 30

# 3. æµ‹è¯•æˆæƒURLç”Ÿæˆï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—
curl "http://localhost:5000/dingtalk/auth-url?state=test"

# 4. æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„è¯¦ç»†è¾“å‡º
docker logs shumu-api-1 2>&1 | grep -A 20 "é’‰é’‰æˆæƒURLç”Ÿæˆ"
```

### æ­¥éª¤ 2ï¼šéªŒè¯é’‰é’‰å¼€æ”¾å¹³å°é…ç½®ï¼ˆå…³é”®ï¼ï¼‰

è¯·**é€ä¸€ç¡®è®¤**ä»¥ä¸‹é…ç½®ï¼Œå¹¶æˆªå›¾æˆ–è®°å½•å…·ä½“å€¼ï¼š

#### 2.1 OAuth2.0å›è°ƒåœ°å€

1. ç™»å½•é’‰é’‰å¼€æ”¾å¹³å°ï¼šhttps://open.dingtalk.com/
2. è¿›å…¥ï¼š**åº”ç”¨å¼€å‘** â†’ **ä¼ä¸šå†…éƒ¨å¼€å‘** â†’ é€‰æ‹©æ‚¨çš„åº”ç”¨
3. è¿›å…¥ï¼š**åº”ç”¨è¯¦æƒ…** â†’ **å¼€å‘ç®¡ç†** â†’ **OAuth2.0å›è°ƒåœ°å€**
4. **è®°å½•å½“å‰é…ç½®çš„å€¼**ï¼ˆå®Œæ•´å¤åˆ¶ï¼ŒåŒ…æ‹¬åè®®ã€åŸŸåã€è·¯å¾„ï¼‰

**æ£€æŸ¥ç‚¹**ï¼š
- [ ] å›è°ƒåœ°å€æ˜¯å¦ä¸ `http://47.106.87.166/login` **å®Œå…¨ä¸€è‡´**ï¼Ÿ
- [ ] æ˜¯å¦æœ‰å¤šä½™çš„ç©ºæ ¼ï¼Ÿ
- [ ] æœ«å°¾æ˜¯å¦æœ‰æ–œæ  `/`ï¼Ÿï¼ˆå¦‚æœæœ‰ï¼Œéœ€è¦åˆ é™¤ï¼‰
- [ ] åè®®æ˜¯ `http://` è¿˜æ˜¯ `https://`ï¼Ÿï¼ˆå¿…é¡»ä¸ä»£ç ä¸­çš„å®Œå…¨ä¸€è‡´ï¼‰

#### 2.2 å®‰å…¨åŸŸåé…ç½®ï¼ˆâš ï¸ æœ€é‡è¦ï¼ï¼‰

1. è¿›å…¥ï¼š**åº”ç”¨è¯¦æƒ…** â†’ **å¼€å‘ç®¡ç†** â†’ **å®‰å…¨åŸŸå**
2. **è®°å½•æ‰€æœ‰å·²æ·»åŠ çš„å®‰å…¨åŸŸå**ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰

**æ£€æŸ¥ç‚¹**ï¼š
- [ ] æ˜¯å¦å·²æ·»åŠ  `47.106.87.166`ï¼Ÿ
- [ ] æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Ÿï¼ˆåº”è¯¥åªæœ‰ `47.106.87.166`ï¼Œæ²¡æœ‰ `http://`ï¼Œæ²¡æœ‰è·¯å¾„ï¼‰
- [ ] æ˜¯å¦æœ‰å…¶ä»–æ ¼å¼çš„åŸŸåï¼Ÿï¼ˆå¦‚ `http://47.106.87.166` æˆ– `47.106.87.166/login`ï¼‰

**æ­£ç¡®æ ¼å¼ç¤ºä¾‹**ï¼š
```
47.106.87.166
```

**é”™è¯¯æ ¼å¼ç¤ºä¾‹**ï¼š
```
http://47.106.87.166          âŒ ä¸è¦åŒ…å«åè®®
https://47.106.87.166         âŒ ä¸è¦åŒ…å«åè®®
47.106.87.166/login           âŒ ä¸è¦åŒ…å«è·¯å¾„
http://47.106.87.166/login    âŒ ä¸è¦åŒ…å«åè®®å’Œè·¯å¾„
```

#### 2.3 åº”ç”¨åŸºæœ¬ä¿¡æ¯

1. è¿›å…¥ï¼š**åº”ç”¨è¯¦æƒ…** â†’ **åŸºæœ¬ä¿¡æ¯**
2. **è®°å½•ä»¥ä¸‹ä¿¡æ¯**ï¼š
   - AppKeyï¼ˆåº”ç”¨Keyï¼‰
   - åº”ç”¨ç±»å‹
   - åº”ç”¨çŠ¶æ€

**æ£€æŸ¥ç‚¹**ï¼š
- [ ] AppKey æ˜¯å¦ä¸ `DINGTALK_APP_KEY` ä¸€è‡´ï¼Ÿ
- [ ] åº”ç”¨ç±»å‹æ˜¯å¦ä¸º"ä¼ä¸šå†…åº”ç”¨"æˆ–"H5å¾®åº”ç”¨"ï¼Ÿ
- [ ] åº”ç”¨çŠ¶æ€æ˜¯å¦ä¸º"å·²å‘å¸ƒ"æˆ–"æ­£å¸¸"ï¼Ÿ

#### 2.4 æƒé™ç®¡ç†

1. è¿›å…¥ï¼š**åº”ç”¨è¯¦æƒ…** â†’ **æƒé™ç®¡ç†**
2. **è®°å½•å·²ç”³è¯·çš„æƒé™åˆ—è¡¨**

**æ£€æŸ¥ç‚¹**ï¼š
- [ ] æ˜¯å¦å·²ç”³è¯·"è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯"æƒé™ï¼Ÿ
- [ ] æƒé™çŠ¶æ€æ˜¯å¦ä¸º"å·²æˆæƒ"ï¼Ÿ
- [ ] æ˜¯å¦è¢«ä¼ä¸šç®¡ç†å‘˜æˆæƒï¼Ÿ

### æ­¥éª¤ 3ï¼šæµ‹è¯•æˆæƒURLçš„å®Œæ•´æµç¨‹

#### 3.1 è·å–æˆæƒURL

```bash
curl "http://localhost:5000/dingtalk/auth-url?state=test"
```

**è®°å½•è¿”å›çš„å®Œæ•´URL**ï¼Œç‰¹åˆ«æ˜¯ `redirect_uri` å‚æ•°çš„å€¼ã€‚

#### 3.2 æ‰‹åŠ¨æµ‹è¯•æˆæƒURL

1. å¤åˆ¶è¿”å›çš„å®Œæ•´æˆæƒURL
2. åœ¨æµè§ˆå™¨ä¸­ç›´æ¥è®¿é—®è¿™ä¸ªURL
3. **è§‚å¯Ÿä¼šå‘ç”Ÿä»€ä¹ˆ**ï¼š
   - æ˜¯å¦è·³è½¬åˆ°é’‰é’‰æˆæƒé¡µé¢ï¼Ÿ
   - è¿˜æ˜¯ç›´æ¥æ˜¾ç¤ºé”™è¯¯é¡µé¢ï¼Ÿ
   - å¦‚æœæ˜¾ç¤ºé”™è¯¯ï¼Œè®°å½•å®Œæ•´çš„é”™è¯¯ä¿¡æ¯

#### 3.3 æ£€æŸ¥æµè§ˆå™¨ç½‘ç»œè¯·æ±‚

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° **Networkï¼ˆç½‘ç»œï¼‰** æ ‡ç­¾
3. ç‚¹å‡»"é’‰é’‰ä¼ä¸šç™»å½•"æŒ‰é’®
4. **è®°å½•ä»¥ä¸‹ä¿¡æ¯**ï¼š
   - å¯¹ `/dingtalk/auth-url` çš„è¯·æ±‚å’Œå“åº”
   - è·³è½¬åˆ°é’‰é’‰çš„å®Œæ•´URLï¼ˆåœ¨åœ°å€æ ï¼‰
   - é’‰é’‰è¿”å›é”™è¯¯æ—¶çš„å®Œæ•´URLï¼ˆåŒ…å«æ‰€æœ‰å‚æ•°ï¼‰

### æ­¥éª¤ 4ï¼šæ£€æŸ¥å¯èƒ½çš„é…ç½®å·®å¼‚

#### 4.1 æ£€æŸ¥å›è°ƒåœ°å€çš„ç»†å¾®å·®å¼‚

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹å®é™…ä½¿ç”¨çš„å›è°ƒåœ°å€ï¼š

```bash
# æŸ¥çœ‹ç¯å¢ƒå˜é‡ä¸­çš„å›è°ƒåœ°å€
docker exec shumu-api-1 env | grep DINGTALK_REDIRECT_URI

# æŸ¥çœ‹ .env æ–‡ä»¶ä¸­çš„å›è°ƒåœ°å€
cat server/.env | grep DINGTALK_REDIRECT_URI
```

**æ£€æŸ¥ç‚¹**ï¼š
- [ ] ä¸¤ä¸ªå€¼æ˜¯å¦å®Œå…¨ä¸€è‡´ï¼Ÿ
- [ ] æ˜¯å¦æœ‰æœ«å°¾æ–œæ çš„å·®å¼‚ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ç©ºæ ¼ï¼Ÿ

#### 4.2 éªŒè¯URLç¼–ç 

æˆæƒURLä¸­çš„ `redirect_uri` å‚æ•°åº”è¯¥æ˜¯URLç¼–ç çš„ã€‚æ£€æŸ¥ç¼–ç æ˜¯å¦æ­£ç¡®ï¼š

```bash
# è·å–æˆæƒURL
AUTH_URL=$(curl -s "http://localhost:5000/dingtalk/auth-url?state=test" | grep -o '"url":"[^"]*"' | cut -d'"' -f4)

# æå– redirect_uri å‚æ•°
echo "$AUTH_URL" | grep -o 'redirect_uri=[^&]*'
```

`redirect_uri` åº”è¯¥æ˜¯ï¼š`redirect_uri=http%3A%2F%2F47.106.87.166%2Flogin`

### æ­¥éª¤ 5ï¼šå°è¯•ä¸åŒçš„é…ç½®

#### 5.1 å°è¯•ä½¿ç”¨ HTTPSï¼ˆå¦‚æœå¯èƒ½ï¼‰

å¦‚æœæ‚¨çš„æœåŠ¡å™¨æ”¯æŒ HTTPSï¼Œå¯ä»¥å°è¯•ï¼š

1. ä¿®æ”¹ `server/.env`ï¼š
   ```env
   DINGTALK_REDIRECT_URI=https://47.106.87.166/login
   ```

2. åœ¨é’‰é’‰å¼€æ”¾å¹³å°ä¿®æ”¹å›è°ƒåœ°å€ä¸ºï¼š`https://47.106.87.166/login`

3. æ·»åŠ å®‰å…¨åŸŸåï¼š`47.106.87.166`ï¼ˆå¦‚æœä½¿ç”¨HTTPSï¼ŒåŸŸååº”è¯¥ç›¸åŒï¼‰

4. é‡å¯å®¹å™¨ï¼š
   ```bash
   docker-compose restart api
   ```

#### 5.2 æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

1. æŒ‰ `Ctrl + Shift + Delete` æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. æˆ–è€…ä½¿ç”¨æ— ç—•æ¨¡å¼è®¿é—®
3. é‡æ–°æµ‹è¯•

## ğŸ¯ æœ€å¯èƒ½çš„åŸå› 

æ ¹æ®ç»éªŒï¼ŒæŒ‰å¯èƒ½æ€§æ’åºï¼š

### 1. å®‰å…¨åŸŸåæ ¼å¼ä¸æ­£ç¡®ï¼ˆ90%å¯èƒ½æ€§ï¼‰

è™½ç„¶æ‚¨è¯´å·²æ·»åŠ å®‰å…¨åŸŸåï¼Œä½†æ ¼å¼å¯èƒ½ä¸å¯¹ã€‚

**è§£å†³æ–¹æ³•**ï¼š
- åˆ é™¤ç°æœ‰çš„å®‰å…¨åŸŸå
- é‡æ–°æ·»åŠ ï¼š`47.106.87.166`ï¼ˆä»…åŸŸåï¼Œä¸è¦åè®®å’Œè·¯å¾„ï¼‰
- ç­‰å¾…å‡ åˆ†é’Ÿè®©é…ç½®ç”Ÿæ•ˆ

### 2. å›è°ƒåœ°å€æœ‰ç»†å¾®å·®å¼‚ï¼ˆ5%å¯èƒ½æ€§ï¼‰

å¯èƒ½çš„é—®é¢˜ï¼š
- æœ«å°¾æœ‰æ–œæ ï¼š`http://47.106.87.166/login/` vs `http://47.106.87.166/login`
- æœ‰å¤šä½™ç©ºæ ¼
- åè®®ä¸ä¸€è‡´ï¼ˆhttp vs httpsï¼‰

**è§£å†³æ–¹æ³•**ï¼š
- ç¡®ä¿é’‰é’‰å¼€æ”¾å¹³å°å’Œä»£ç ä¸­çš„å›è°ƒåœ°å€**å®Œå…¨ä¸€è‡´**ï¼ˆåŒ…æ‹¬æœ«å°¾æ–œæ ï¼‰

### 3. åº”ç”¨æƒé™æœªæˆæƒï¼ˆ3%å¯èƒ½æ€§ï¼‰

**è§£å†³æ–¹æ³•**ï¼š
- ç¡®ä¿æƒé™å·²è¢«ä¼ä¸šç®¡ç†å‘˜æˆæƒ
- å¦‚æœæƒé™è¢«æ‹’ç»ï¼Œéœ€è¦é‡æ–°ç”³è¯·

### 4. åº”ç”¨æœªå‘å¸ƒï¼ˆ2%å¯èƒ½æ€§ï¼‰

**è§£å†³æ–¹æ³•**ï¼š
- ç¡®ä¿åº”ç”¨å·²å‘å¸ƒä¸Šçº¿
- å¦‚æœæ˜¯æ–°åº”ç”¨ï¼Œå¯èƒ½éœ€è¦ç­‰å¾…å®¡æ ¸

## ğŸ“ éœ€è¦æä¾›çš„ä¿¡æ¯

ä¸ºäº†è¿›ä¸€æ­¥è¯Šæ–­ï¼Œè¯·æä¾›ï¼š

1. **é’‰é’‰å¼€æ”¾å¹³å°é…ç½®æˆªå›¾**ï¼š
   - OAuth2.0å›è°ƒåœ°å€çš„å®Œæ•´å€¼
   - å®‰å…¨åŸŸååˆ—è¡¨çš„å®Œæ•´åˆ—è¡¨
   - åº”ç”¨åŸºæœ¬ä¿¡æ¯ï¼ˆAppKeyã€åº”ç”¨ç±»å‹ã€çŠ¶æ€ï¼‰

2. **åç«¯æ—¥å¿—**ï¼š
   ```bash
   docker logs shumu-api-1 2>&1 | grep -A 20 "é’‰é’‰æˆæƒURLç”Ÿæˆ"
   ```

3. **æµè§ˆå™¨ç½‘ç»œè¯·æ±‚è¯¦æƒ…**ï¼š
   - å¯¹ `/dingtalk/auth-url` çš„å®Œæ•´è¯·æ±‚å’Œå“åº”
   - è·³è½¬åˆ°é’‰é’‰çš„å®Œæ•´URL
   - é’‰é’‰è¿”å›é”™è¯¯æ—¶çš„å®Œæ•´URL

4. **æ‰‹åŠ¨æµ‹è¯•ç»“æœ**ï¼š
   - ç›´æ¥è®¿é—®æˆæƒURLä¼šå‘ç”Ÿä»€ä¹ˆ

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [é’‰é’‰å¼€æ”¾å¹³å°æ–‡æ¡£](https://open.dingtalk.com/document/)
- [é’‰é’‰OAuth2.0è®¤è¯](https://open.dingtalk.com/document/orgapp-server/obtain-identity-credentials)
- [DINGTALK_DOCKER_FIX.md](./DINGTALK_DOCKER_FIX.md)

