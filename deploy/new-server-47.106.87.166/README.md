# æ–°æœåŠ¡å™¨éƒ¨ç½²é…ç½®åŒ…

## ğŸ“‹ æœåŠ¡å™¨ä¿¡æ¯
- **æœåŠ¡å™¨ IP**: 47.106.87.166
- **æ•°æ®åº“**: é˜¿é‡Œäº‘ RDSï¼ˆä¸ç°æœ‰æœåŠ¡å™¨å…±äº«ï¼‰
- **éƒ¨ç½²æ–¹å¼**: Docker + å®å¡”é¢æ¿

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²æ­¥éª¤

### æ–¹å¼ A: ä½¿ç”¨è‡ªåŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰

1. **SSH ç™»å½•æœåŠ¡å™¨**
```bash
ssh root@47.106.87.166
```

2. **æ‰§è¡Œä»¥ä¸‹å‘½ä»¤**
```bash
cd /www/wwwroot
git clone -b main https://github.com/xuxiang6/shumu.git
cd shumu

# å¤åˆ¶å¹¶æ‰§è¡Œéƒ¨ç½²è„šæœ¬
bash deploy/new-server-47.106.87.166/2-deploy-commands.sh
```

3. **æŒ‰ç…§è„šæœ¬æç¤ºæ“ä½œ**
   - é…ç½® `.env` æ–‡ä»¶ï¼ˆå¡«å†™æ•°æ®åº“ä¿¡æ¯ï¼‰
   - ç­‰å¾… Docker é•œåƒæ„å»º
   - åœ¨å®å¡”é…ç½® Nginx

### æ–¹å¼ B: æ‰‹åŠ¨åˆ†æ­¥éƒ¨ç½²

å‚è€ƒï¼š`../NEW_SERVER_DOCKER_DEPLOY.md`

---

## ğŸ“ é…ç½®æ–‡ä»¶è¯´æ˜

### 1ï¸âƒ£ `1-env-config.txt`
ç¯å¢ƒå˜é‡é…ç½®æ¨¡æ¿ï¼ŒåŒ…å«ï¼š
- æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼ˆéœ€è¦å¡«å†™ RDS ç”¨æˆ·åå’Œå¯†ç ï¼‰
- JWT å®‰å…¨å¯†é’¥ï¼ˆéœ€è¦ç”Ÿæˆï¼‰
- åº”ç”¨é…ç½®

**ä½¿ç”¨æ­¥éª¤ï¼š**
```bash
# 1. ç”Ÿæˆ JWT å¯†é’¥
openssl rand -base64 32

# 2. å¤åˆ¶é…ç½®æ¨¡æ¿
cd /www/wwwroot/shumu
cp deploy/new-server-47.106.87.166/1-env-config.txt .env

# 3. ç¼–è¾‘é…ç½®æ–‡ä»¶
vim .env
# æˆ–ä½¿ç”¨å®å¡”æ–‡ä»¶ç®¡ç†å™¨ç¼–è¾‘

# 4. å¡«å†™å†…å®¹ï¼š
# - DATABASE_URL: mysql://ç”¨æˆ·å:å¯†ç @guishumu999666.rwlb.rds.aliyuncs.com:3306/sm_shangping
# - JWT_SECRET: ç²˜è´´ä¸Šé¢ç”Ÿæˆçš„éšæœºå¯†é’¥
```

### 2ï¸âƒ£ `2-deploy-commands.sh`
è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
- æ£€æŸ¥ Docker å’Œ Git ç¯å¢ƒ
- å…‹éš†é¡¹ç›®ä»£ç 
- åˆ›å»º `.env` é…ç½®æ–‡ä»¶
- æ„å»º Docker é•œåƒ
- å¯åŠ¨å®¹å™¨
- éªŒè¯æœåŠ¡çŠ¶æ€

**æ‰§è¡Œæ–¹å¼ï¼š**
```bash
bash deploy/new-server-47.106.87.166/2-deploy-commands.sh
```

### 3ï¸âƒ£ `3-nginx-config.conf`
Nginx åå‘ä»£ç†é…ç½®æ–‡ä»¶

**ä½¿ç”¨æ­¥éª¤ï¼ˆå¦‚æœæœ‰åŸŸåï¼‰ï¼š**

1. åœ¨å®å¡”é¢æ¿æ·»åŠ ç½‘ç«™
   - ç½‘ç«™ â†’ æ·»åŠ ç«™ç‚¹
   - åŸŸåï¼šè¾“å…¥ä½ çš„åŸŸå
   - æ ¹ç›®å½•ï¼š`/www/wwwroot/shumu`ï¼ˆéšä¾¿é€‰ï¼Œä¸ä¼šå®é™…ä½¿ç”¨ï¼‰
   - PHP ç‰ˆæœ¬ï¼šçº¯é™æ€

2. é…ç½®åå‘ä»£ç†
   - ç½‘ç«™è®¾ç½® â†’ é…ç½®æ–‡ä»¶
   - å°† `3-nginx-config.conf` çš„å†…å®¹å¤åˆ¶è¿›å»
   - ä¿®æ”¹ `server_name` ä¸ºä½ çš„å®é™…åŸŸå
   - ä¿å­˜å¹¶é‡å¯ Nginx

**å¦‚æœæ²¡æœ‰åŸŸåï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰ï¼š**
- ç›´æ¥è®¿é—® `http://47.106.87.166:3000`
- éœ€è¦åœ¨å®å¡”å®‰å…¨é¢æ¿æ”¾è¡Œ 3000 å’Œ 5000 ç«¯å£

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] æœåŠ¡å™¨å·²å®‰è£…å®å¡”é¢æ¿
- [ ] å®å¡”å·²å®‰è£… Docker ç®¡ç†å™¨
- [ ] æœåŠ¡å™¨å¯ä»¥è®¿é—® GitHub
- [ ] å·²è·å– RDS æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç 

### éƒ¨ç½²ä¸­æ£€æŸ¥
- [ ] `.env` æ–‡ä»¶å·²æ­£ç¡®é…ç½®
- [ ] JWT_SECRET å·²ç”Ÿæˆå¹¶å¡«å†™
- [ ] Docker é•œåƒæ„å»ºæˆåŠŸ
- [ ] å®¹å™¨å¯åŠ¨æˆåŠŸï¼ˆ`docker-compose ps` æ˜¾ç¤º Upï¼‰

### éƒ¨ç½²åæ£€æŸ¥
- [ ] API å¥åº·æ£€æŸ¥æ­£å¸¸ï¼š`curl http://127.0.0.1:5000/health`
- [ ] Web å‰ç«¯å¯ä»¥è®¿é—®ï¼š`curl -I http://127.0.0.1:3000`
- [ ] Nginx åå‘ä»£ç†é…ç½®æ­£ç¡®ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
- [ ] é˜²ç«å¢™ç«¯å£å·²æ”¾è¡Œ
- [ ] å¯ä»¥æ­£å¸¸ç™»å½•ç³»ç»Ÿ
- [ ] å„åŠŸèƒ½æ¨¡å—æµ‹è¯•æ­£å¸¸

---

## ğŸ” éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
```bash
cd /www/wwwroot/shumu
docker-compose ps
```
**é¢„æœŸè¾“å‡ºï¼š**
```
NAME                COMMAND                  SERVICE   STATUS    PORTS
shumu-api-1         "node dist/main.js"      api       Up        0.0.0.0:5000->5000/tcp
shumu-web-1         "node server.js"         web       Up        0.0.0.0:3000->3000/tcp
```

### 2. æµ‹è¯• API
```bash
# å¥åº·æ£€æŸ¥
curl http://127.0.0.1:5000/health
# é¢„æœŸè¾“å‡ºï¼š{"status":"ok"}

# é€šè¿‡åŸŸåè®¿é—®ï¼ˆå¦‚æœé…ç½®äº† Nginxï¼‰
curl http://ä½ çš„åŸŸå.com/api/health
```

### 3. æµ‹è¯• Web å‰ç«¯
```bash
# ç›´æ¥è®¿é—®
curl -I http://127.0.0.1:3000

# é€šè¿‡åŸŸåè®¿é—®ï¼ˆå¦‚æœé…ç½®äº† Nginxï¼‰
curl -I http://ä½ çš„åŸŸå.com
```

### 4. æµè§ˆå™¨æµ‹è¯•
- æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://ä½ çš„åŸŸå.com` æˆ– `http://47.106.87.166:3000`
- åº”è¯¥çœ‹åˆ°ç™»å½•é¡µé¢
- å°è¯•ç™»å½•å¹¶æµ‹è¯•å„åŠŸèƒ½

---

## ğŸ“Š æŸ¥çœ‹æ—¥å¿—

```bash
cd /www/wwwroot/shumu

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# åªæŸ¥çœ‹ API æ—¥å¿—
docker-compose logs -f api

# åªæŸ¥çœ‹ Web æ—¥å¿—
docker-compose logs -f web

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿—
docker-compose logs --tail=100
```

---

## ğŸ”„ ç»´æŠ¤å‘½ä»¤

### é‡å¯æœåŠ¡
```bash
cd /www/wwwroot/shumu

# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose restart

# åªé‡å¯ API
docker-compose restart api

# åªé‡å¯ Web
docker-compose restart web
```

### æ›´æ–°ä»£ç 
```bash
cd /www/wwwroot/shumu

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# é‡æ–°æ„å»ºå¹¶é‡å¯
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### åœæ­¢æœåŠ¡
```bash
cd /www/wwwroot/shumu

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ˆè°¨æ…ï¼ï¼‰
docker-compose down -v
```

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. å®¹å™¨æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose logs

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep -E '3000|5000'

# å¦‚æœç«¯å£è¢«å ç”¨ï¼Œåœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹
```

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥ .env é…ç½®
cat .env | grep DATABASE_URL

# æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼ˆä»å®¹å™¨å†…ï¼‰
docker-compose exec api npx prisma db push
```

### 3. Nginx 502 é”™è¯¯
```bash
# æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
docker-compose ps

# æ£€æŸ¥ Nginx é…ç½®
nginx -t

# é‡å¯ Nginx
systemctl restart nginx
```

### 4. Web å‰ç«¯ç©ºç™½
```bash
# æŸ¥çœ‹ Web æ—¥å¿—
docker-compose logs web --tail=100

# æ£€æŸ¥é™æ€æ–‡ä»¶
docker-compose exec web ls -la /app/web/.next/static
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. ä¿®æ”¹é»˜è®¤é…ç½®
- âœ… ä½¿ç”¨å¼º JWT å¯†é’¥ï¼š`openssl rand -base64 32`
- âœ… æ•°æ®åº“ä½¿ç”¨å¼ºå¯†ç 
- âœ… å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œè½¯ä»¶

### 2. é˜²ç«å¢™è®¾ç½®
- âœ… åªå¼€æ”¾ 80 å’Œ 443 ç«¯å£ï¼ˆä½¿ç”¨ Nginx ä»£ç†ï¼‰
- âœ… å…³é—­ 3000 å’Œ 5000 ç«¯å£å¯¹å¤–è®¿é—®
- âœ… å¯ç”¨å®å¡”çš„ SSH é˜²æŠ¤

### 3. å®šæœŸå¤‡ä»½
- âœ… åœ¨å®å¡”é¢æ¿è®¾ç½®æ•°æ®åº“å®šæœŸå¤‡ä»½
- âœ… å¤‡ä»½ `.env` é…ç½®æ–‡ä»¶
- âœ… å¤‡ä»½é‡è¦æ•°æ®

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœéƒ¨ç½²é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

```bash
# 1. ç³»ç»Ÿä¿¡æ¯
uname -a
docker --version
docker-compose --version

# 2. å®¹å™¨çŠ¶æ€
cd /www/wwwroot/shumu
docker-compose ps

# 3. å®¹å™¨æ—¥å¿—
docker-compose logs --tail=200 > /tmp/deploy-logs.txt
cat /tmp/deploy-logs.txt

# 4. ç«¯å£å ç”¨
netstat -tlnp | grep -E '80|443|3000|5000'

# 5. Nginx çŠ¶æ€
systemctl status nginx
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´éƒ¨ç½²æŒ‡å—](../NEW_SERVER_DOCKER_DEPLOY.md)
- [å®å¡” Docker éƒ¨ç½²](../baota-docker-deploy.md)
- [é¡¹ç›®ä¸»æ–‡æ¡£](../../README.md)

---

## ğŸ¯ å¿«é€Ÿå‚è€ƒ

| é¡¹ç›® | å€¼ |
|------|-----|
| æœåŠ¡å™¨ IP | 47.106.87.166 |
| é¡¹ç›®ç›®å½• | /www/wwwroot/shumu |
| Web ç«¯å£ | 3000 |
| API ç«¯å£ | 5000 |
| æ•°æ®åº“ | guishumu999666.rwlb.rds.aliyuncs.com:3306 |
| Git åˆ†æ”¯ | main |

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼** ğŸ‰

