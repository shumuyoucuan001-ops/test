# Nginx 反向代理配置
# 服务器 IP: 47.106.87.166
#
# 使用方法：
# 1. 在宝塔面板添加网站（如果有域名）
# 2. 进入：网站设置 → 配置文件
# 3. 将此配置替换到 server {} 块中

# ============================================
# 方式 A: 使用域名访问（推荐）
# ============================================
server {
    listen 80;
    server_name 你的域名.com;  # 修改为你的实际域名
    
    # 如果配置了 SSL，添加以下行：
    # listen 443 ssl http2;
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;
    
    # API 反向代理
    location /api {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
        send_timeout 600;
    }
    
    # Web 前端反向代理
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Next.js 特殊配置
        proxy_buffering off;
    }
    
    # 禁用缓存（开发调试用，生产环境可以启用缓存）
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
    
    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # 日志
    access_log /www/wwwlogs/shumu-access.log;
    error_log /www/wwwlogs/shumu-error.log;
}

# ============================================
# 方式 B: 直接用 IP 访问（临时方案）
# ============================================
# 如果不配置域名，可以直接访问：
# - Web 前端: http://47.106.87.166:3000
# - API: http://47.106.87.166:5000
#
# 需要在宝塔安全面板放行以下端口：
# - 3000 (Web)
# - 5000 (API)
#
# 注意：这种方式不推荐用于生产环境

# ============================================
# SSL 配置（可选）
# ============================================
# 如果需要 HTTPS，在宝塔面板：
# 1. 网站设置 → SSL
# 2. 选择 Let's Encrypt（免费）
# 3. 勾选域名 → 申请
# 4. 开启"强制 HTTPS"

# ============================================
# 性能优化（可选）
# ============================================
# 启用 gzip 压缩
# gzip on;
# gzip_vary on;
# gzip_min_length 1024;
# gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;

# 客户端缓存静态资源
# location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
#     proxy_pass http://127.0.0.1:3000;
#     expires 30d;
#     add_header Cache-Control "public, immutable";
# }

