# ðŸš€ å®å¡”é¢æ¿ - ä½¿ç”¨ Git éƒ¨ç½²æ–°åŽç«¯æœåŠ¡

## ðŸ“‹ **éƒ¨ç½²æ–¹æ¡ˆ**

åˆ›å»ºä¸€ä¸ªæ–°çš„åŽç«¯æœåŠ¡ `sm-api-v2`ï¼Œä½¿ç”¨ Git è‡ªåŠ¨éƒ¨ç½²ï¼Œä¸Žæ—§æœåŠ¡å…±å­˜ã€‚

### **é…ç½®å¯¹æ¯”**

| é¡¹ç›®     | æ—§åŽç«¯ (sm-api)           | æ–°åŽç«¯ (sm-api-v2)            |
| -------- | ------------------------- | ----------------------------- |
| ç«¯å£     | 4000                      | **5000**                      |
| éƒ¨ç½²æ–¹å¼ | æ‰‹åŠ¨ä¸Šä¼                   | **Git è‡ªåŠ¨éƒ¨ç½²**              |
| ä»£ç ç‰ˆæœ¬ | æ—§ç‰ˆæœ¬                    | **æœ€æ–° develop åˆ†æ”¯**         |
| API åœ°å€ | api.shuzhishanmu.com:4000 | **api.shuzhishanmu.com:5000** |
| çŠ¶æ€     | ä¿ç•™è¿è¡Œ                  | **æ–°å»º**                      |

---

## ðŸ“ **æ­¥éª¤ 1: åœ¨å®å¡”é¢æ¿åˆ›å»ºæ–° Node é¡¹ç›®**

### 1.1 ç™»å½•å®å¡”é¢æ¿

- è®¿é—®: http://121.43.139.147:8888
- ç™»å½•æ‚¨çš„å®å¡”è´¦å·

### 1.2 åˆ›å»ºæ–°çš„ Node é¡¹ç›®

1. ç‚¹å‡»å·¦ä¾§ **"Node é¡¹ç›®"**
2. ç‚¹å‡» **"æ·»åŠ é¡¹ç›®"**
3. å¡«å†™é¡¹ç›®ä¿¡æ¯ï¼š

```
é¡¹ç›®åç§°: sm-api-v2
è¿è¡Œç›®å½•: /www/wwwroot/sm-api-v2
ç«¯å£: 5000
å¯åŠ¨æ–‡ä»¶: dist/main.js
å¯åŠ¨å‘½ä»¤: node
è¿è¡Œç”¨æˆ·: www

âœ… å‹¾é€‰: å¼€æœºè‡ªå¯åŠ¨
âœ… å‹¾é€‰: è‡ªåŠ¨é‡å¯
```

4. ç‚¹å‡» **"æäº¤"**

---

## ðŸ“ **æ­¥éª¤ 2: é…ç½® Git éƒ¨ç½²**

### 2.1 åœ¨å®å¡”é¢æ¿é…ç½® Git

1. åœ¨ Node é¡¹ç›®åˆ—è¡¨ä¸­æ‰¾åˆ° **sm-api-v2**
2. ç‚¹å‡» **"è®¾ç½®"**
3. æ‰¾åˆ° **"Git éƒ¨ç½²"** é€‰é¡¹å¡
4. å¡«å†™ Git ä»“åº“ä¿¡æ¯ï¼š

```
Gitåœ°å€: https://github.com/xuxiang6/shumu.git
åˆ†æ”¯: develop
éƒ¨ç½²ç›®å½•: /www/wwwroot/sm-api-v2
```

5. ç‚¹å‡» **"æ‹‰å–"** æŒ‰é’®

### 2.2 è®¾ç½®é¡¹ç›®ç›®å½•

ç”±äºŽæˆ‘ä»¬çš„åŽç«¯ä»£ç åœ¨ `server/` å­ç›®å½•ä¸­ï¼Œéœ€è¦è°ƒæ•´ï¼š

**æ–¹æ³• A: åœ¨å®å¡”ç»ˆç«¯æ‰§è¡Œ**ï¼ˆæŽ¨èï¼‰

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /www/wwwroot/sm-api-v2

# å°†serverç›®å½•çš„å†…å®¹ç§»åˆ°æ ¹ç›®å½•
mv server/* .
mv server/.* . 2>/dev/null || true
rmdir server

# å®‰è£…ä¾èµ–
npm install

# æž„å»ºé¡¹ç›®
npm run build
```

**æ–¹æ³• B: ä¿®æ”¹å®å¡”é¡¹ç›®é…ç½®**

1. é¡¹ç›®è®¾ç½® â†’ è¿è¡Œç›®å½•
2. æ”¹ä¸º: `/www/wwwroot/sm-api-v2/server`
3. å¯åŠ¨æ–‡ä»¶: `dist/main.js`

---

## ðŸ“ **æ­¥éª¤ 3: é…ç½®çŽ¯å¢ƒå’Œå¯åŠ¨**

### 3.1 åˆ›å»ºçŽ¯å¢ƒæ–‡ä»¶ï¼ˆå¦‚æžœéœ€è¦ï¼‰

åœ¨å®å¡”ç»ˆç«¯æ‰§è¡Œï¼š

```bash
cd /www/wwwroot/sm-api-v2

# åˆ›å»º.envæ–‡ä»¶ï¼ˆå¦‚æžœéœ€è¦ï¼‰
cat > .env << 'EOF'
PORT=5000
NODE_ENV=production
DATABASE_URL="file:./prisma/dev.db"
EOF
```

### 3.2 åˆå§‹åŒ–æ•°æ®åº“

```bash
cd /www/wwwroot/sm-api-v2

# ç”ŸæˆPrisma Client
npx prisma generate

# è¿è¡Œæ•°æ®åº“è¿ç§»
npx prisma migrate deploy
```

### 3.3 å¯åŠ¨é¡¹ç›®

åœ¨å®å¡”é¢æ¿ä¸­ï¼š

1. æ‰¾åˆ° **sm-api-v2** é¡¹ç›®
2. ç‚¹å‡» **"å¯åŠ¨"** æŒ‰é’®

---

## ðŸ“ **æ­¥éª¤ 4: é…ç½®é˜²ç«å¢™å’Œå®‰å…¨ç»„**

### 4.1 é…ç½®é˜¿é‡Œäº‘å®‰å…¨ç»„

1. è®¿é—®: https://ecs.console.aliyun.com/
2. æ‰¾åˆ° ECS å®žä¾‹ (121.43.139.147)
3. ç‚¹å‡» "å®‰å…¨ç»„" â†’ "é…ç½®è§„åˆ™"
4. æ·»åŠ è§„åˆ™ï¼š
   ```
   åè®®ç±»åž‹: è‡ªå®šä¹‰TCP
   ç«¯å£èŒƒå›´: 5000/5000
   æŽˆæƒå¯¹è±¡: 0.0.0.0/0
   æè¿°: sm-api-v2æ–°åŽç«¯æœåŠ¡
   ```

### 4.2 é…ç½®å®å¡”é˜²ç«å¢™

1. åœ¨å®å¡”é¢æ¿å·¦ä¾§ç‚¹å‡» **"å®‰å…¨"**
2. ç‚¹å‡» **"æ·»åŠ è§„åˆ™"**
3. å¡«å†™ï¼š
   ```
   ç«¯å£: 5000
   è¯´æ˜Ž: sm-api-v2æ–°åŽç«¯æœåŠ¡
   ```
4. ç‚¹å‡» **"æ”¾è¡Œ"**

---

## ðŸ§ª **æ­¥éª¤ 5: æµ‹è¯•æ–°åŽç«¯ API**

### ä»Ž Mac æœ¬åœ°æµ‹è¯•

```bash
# 1. æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://121.43.139.147:5000/health

# 2. æµ‹è¯•ç‰ˆæœ¬æ£€æŸ¥
curl "http://121.43.139.147:5000/version/check?current=25.10.03.04"

# 3. æµ‹è¯•æ¨¡æ¿ç”Ÿæˆ
curl -X POST http://121.43.139.147:5000/template/generate-tspl \
  -H "Content-Type: application/json" \
  -d '{"templateId":"default","data":{"sku":"TEST123"},"copies":1}'
```

**é¢„æœŸç»“æžœï¼š**

- `/health` è¿”å›ž: `{"status":"ok"}`
- `/version/check` è¿”å›žç‰ˆæœ¬ä¿¡æ¯
- `/template/generate-tspl` è¿”å›ž TSPL å‘½ä»¤

---

## ðŸ“ **æ­¥éª¤ 6: ä½¿ç”¨åŸŸåè®¿é—®ï¼ˆå¯é€‰ï¼‰**

### æ–¹æ¡ˆ A: ä½¿ç”¨ä¸åŒç«¯å£

```
æ—§åŽç«¯: http://api.shuzhishanmu.com:4000
æ–°åŽç«¯: http://api.shuzhishanmu.com:5000
```

### æ–¹æ¡ˆ B: ä½¿ç”¨ä¸åŒå­åŸŸåï¼ˆæŽ¨èï¼‰

1. é…ç½® DNS A è®°å½•ï¼š

   ```
   ä¸»æœºè®°å½•: api-v2
   è®°å½•ç±»åž‹: A
   è®°å½•å€¼: 121.43.139.147
   ```

2. è®¿é—®åœ°å€ï¼š
   ```
   æ—§åŽç«¯: http://api.shuzhishanmu.com:4000
   æ–°åŽç«¯: http://api-v2.shuzhishanmu.com:5000
   ```

### æ–¹æ¡ˆ C: é…ç½® Nginx åå‘ä»£ç†ï¼ˆæœ€ä¸“ä¸šï¼‰

åœ¨å®å¡”é¢æ¿é…ç½®ï¼š

```nginx
# æ–°åŽç«¯ä½¿ç”¨5000ç«¯å£ï¼Œä¸å¸¦ç«¯å£å·è®¿é—®
location /api/v2/ {
    proxy_pass http://127.0.0.1:5000/;
}

# æ—§åŽç«¯ä¿æŒä¸å˜
location /api/ {
    proxy_pass http://127.0.0.1:4000/;
}
```

---

## ðŸŽ¯ **åŽç»­æ“ä½œ**

### 1. ç§»åŠ¨åº”ç”¨é…ç½®æ›´æ–°

ä¿®æ”¹ `SmLabelAppRN/src/api.ts`:

**æ–¹æ¡ˆ A: ç›´æŽ¥ä½¿ç”¨æ–°ç«¯å£**

```typescript
const API_BASE_URL = "http://api.shuzhishanmu.com:5000";
```

**æ–¹æ¡ˆ B: ä½¿ç”¨æ–°å­åŸŸå**

```typescript
const API_BASE_URL = "http://api-v2.shuzhishanmu.com:5000";
```

### 2. æµ‹è¯•å®ŒæˆåŽ

å¦‚æžœæ–°åŽç«¯æµ‹è¯•å®Œå…¨æ­£å¸¸ï¼š

1. âœ… ä¿ç•™æ—§åŽç«¯ï¼ˆsm-apiï¼‰ä½œä¸ºå¤‡ä»½
2. âœ… æ–°åº”ç”¨ç‰ˆæœ¬å…¨éƒ¨ä½¿ç”¨æ–°åŽç«¯ï¼ˆsm-api-v2ï¼‰
3. âœ… è§‚å¯Ÿä¸€æ®µæ—¶é—´åŽï¼Œå¯ä»¥åœæ­¢æ—§åŽç«¯

---

## ðŸ”§ **å¸¸ç”¨è¿ç»´å‘½ä»¤**

### æŸ¥çœ‹é¡¹ç›®æ—¥å¿—

```bash
cd /www/wwwroot/sm-api-v2
pm2 logs sm-api-v2
```

### é‡å¯é¡¹ç›®

```bash
pm2 restart sm-api-v2
```

### æ›´æ–°ä»£ç 

```bash
cd /www/wwwroot/sm-api-v2
git pull origin develop
npm install
npm run build
pm2 restart sm-api-v2
```

### æŸ¥çœ‹é¡¹ç›®çŠ¶æ€

```bash
pm2 status
```

---

## ðŸ“Œ **æ³¨æ„äº‹é¡¹**

1. **æ•°æ®åº“ç‹¬ç«‹**

   - æ–°åŽç«¯ä¼šæœ‰è‡ªå·±çš„æ•°æ®åº“æ–‡ä»¶
   - å¦‚éœ€è¿ç§»æ•°æ®ï¼Œéœ€è¦ä»Žæ—§åŽç«¯å¤åˆ¶æ•°æ®åº“æ–‡ä»¶

2. **ç«¯å£å†²çª**

   - ç¡®ä¿ 5000 ç«¯å£æœªè¢«å ç”¨
   - å¯ä»¥ç”¨ `netstat -tulpn | grep 5000` æ£€æŸ¥

3. **Git éƒ¨ç½²ä¼˜åŠ¿**
   - åŽç»­æ›´æ–°åªéœ€ `git pull` + `npm run build` + `pm2 restart`
   - ä»£ç ç‰ˆæœ¬å¯è¿½æº¯
   - æ”¯æŒå›žæ»š

---

## ðŸš¨ **æ•…éšœæŽ’æŸ¥**

### é—®é¢˜ 1: Git æ‹‰å–å¤±è´¥

```bash
# æ£€æŸ¥ç½‘ç»œ
ping github.com

# ä½¿ç”¨SSHå¯†é’¥ï¼ˆå¦‚æžœé…ç½®äº†ï¼‰
cd /www/wwwroot/sm-api-v2
git remote set-url origin git@github.com:xuxiang6/shumu.git
```

### é—®é¢˜ 2: npm install å¤±è´¥

```bash
# åˆ‡æ¢æ·˜å®é•œåƒ
npm config set registry https://registry.npmmirror.com
npm install
```

### é—®é¢˜ 3: å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs sm-api-v2 --lines 100

# æ£€æŸ¥æž„å»ºæ˜¯å¦æˆåŠŸ
ls -la /www/wwwroot/sm-api-v2/dist/
```

---

## âœ… **éƒ¨ç½²æ£€æŸ¥æ¸…å•**

- [ ] åœ¨å®å¡”é¢æ¿åˆ›å»º sm-api-v2 é¡¹ç›®
- [ ] é…ç½® Git ä»“åº“å¹¶æ‹‰å–ä»£ç 
- [ ] è°ƒæ•´ç›®å½•ç»“æž„ï¼ˆå¦‚æžœéœ€è¦ï¼‰
- [ ] å®‰è£…ä¾èµ– `npm install`
- [ ] æž„å»ºé¡¹ç›® `npm run build`
- [ ] åˆå§‹åŒ–æ•°æ®åº“
- [ ] é…ç½®é˜¿é‡Œäº‘å®‰å…¨ç»„ï¼ˆ5000 ç«¯å£ï¼‰
- [ ] é…ç½®å®å¡”é˜²ç«å¢™ï¼ˆ5000 ç«¯å£ï¼‰
- [ ] å¯åŠ¨é¡¹ç›®
- [ ] æµ‹è¯• API æŽ¥å£
- [ ] ä¿®æ”¹ç§»åŠ¨åº”ç”¨ API åœ°å€
- [ ] é‡æ–°æž„å»º APK æµ‹è¯•

---

**å®ŒæˆåŽå‘Šè¯‰æˆ‘ç»“æžœï¼Œæˆ‘ä¼šå¸®æ‚¨éªŒè¯å’Œæµ‹è¯•ï¼** ðŸš€
