# 📖 宝塔部署新后端 - 详细步骤指南

## 🎯 **正确的操作顺序**

1. ✅ 先在终端部署代码
2. ✅ 再在宝塔面板添加 Node 项目

---

## 第一步：在宝塔终端部署代码（10 分钟）

### 1.1 打开宝塔终端

在宝塔面板：

1. 找到右上角的 **"终端"** 图标（看起来像一个黑色窗口）
2. 点击打开终端窗口

### 1.2 复制并执行以下命令

**⚠️ 请一次性复制整段代码，粘贴到终端中，然后按回车执行**

```bash
#!/bin/bash
echo "========================================"
echo "🚀 开始部署 sm-api-v2"
echo "========================================"

# 1. 进入www目录
cd /www/wwwroot || exit

# 2. 克隆代码到临时目录
echo ""
echo "📥 步骤1/7: 克隆GitHub代码..."
git clone -b develop https://github.com/xuxiang6/shumu.git sm-api-v2-temp

# 3. 创建项目目录
echo ""
echo "📁 步骤2/7: 创建项目目录..."
mkdir -p sm-api-v2

# 4. 复制server目录内容
echo ""
echo "📋 步骤3/7: 复制后端代码..."
cp -r sm-api-v2-temp/server/* sm-api-v2/
rm -rf sm-api-v2-temp

# 5. 进入项目目录
cd sm-api-v2 || exit

# 6. 配置npm镜像源（加速安装）
echo ""
echo "⚙️  步骤4/7: 配置npm镜像..."
npm config set registry https://registry.npmmirror.com

# 7. 安装依赖
echo ""
echo "📦 步骤5/7: 安装依赖包..."
npm install

# 8. 生成Prisma Client和初始化数据库
echo ""
echo "🗄️  步骤6/7: 初始化数据库..."
npx prisma generate
npx prisma migrate deploy

# 9. 构建项目
echo ""
echo "🔨 步骤7/7: 构建项目..."
npm run build

# 10. 检查结果
echo ""
echo "========================================"
echo "✅ 部署完成！"
echo "========================================"
echo ""
echo "📂 项目路径: /www/wwwroot/sm-api-v2"
echo "📄 启动文件: dist/main.js"
echo ""
echo "🔍 检查构建结果:"
ls -lh dist/main.js 2>/dev/null && echo "✅ main.js 已生成" || echo "❌ main.js 未找到"

echo ""
echo "🎉 现在可以在宝塔面板添加Node项目了！"
```

### 1.3 等待执行完成

**预期时间**: 5-10 分钟（主要是 npm install）

**预期结果**: 最后应该显示：

```
✅ 部署完成！
📂 项目路径: /www/wwwroot/sm-api-v2
✅ main.js 已生成
🎉 现在可以在宝塔面板添加Node项目了！
```

**⚠️ 如果出现错误，请截图告诉我！**

---

## 第二步：在宝塔面板添加 Node 项目（2 分钟）

### 2.1 打开添加 Node 项目界面

1. 在宝塔面板左侧点击 **"Node 项目"**
2. 点击 **"添加项目"**

### 2.2 选择"默认项目"标签页

确保选中第一个标签：**"默认项目"**（绿色的那个）

### 2.3 填写项目信息

请完全按照以下内容填写：

| 字段          | 填写内容                                     |
| ------------- | -------------------------------------------- |
| **项目目录**  | `/www/wwwroot/sm-api-v2`                     |
| **项目名称**  | `sm-api-v2`                                  |
| **启动选项**  | 点击下拉框，**不要选择任何预设**，留空即可！ |
| **Node 版本** | `v20.19.5`（保持默认）                       |
| **包管理器**  | `pnpm` 或 `npm`（任选）                      |

### 2.4 展开更多配置

点击底部的 **"点击查看，更多配置"** 展开

### 2.5 填写高级配置

| 字段         | 填写内容       |
| ------------ | -------------- |
| **启动文件** | `dist/main.js` |
| **项目端口** | `5000`         |
| **启动方式** | `node`         |
| **运行用户** | `www`          |

**如果有以下选项，请勾选：**

- ✅ 开机自启动
- ✅ 自动重启

### 2.6 点击"确定"

填写完成后，点击右下角绿色的 **"确定"** 按钮

---

## 第三步：启动项目（1 分钟）

### 3.1 找到项目

在 Node 项目列表中找到 **sm-api-v2**

### 3.2 启动项目

点击项目右侧的 **"启动"** 按钮

**预期结果**：项目状态变为 **"运行中"**（绿色圆点）

**⚠️ 如果启动失败，点击"日志"查看错误信息，并告诉我**

---

## 第四步：验证部署（我来执行）

**您完成上述 3 步后，告诉我"已完成"**

我会在 Mac 本地执行以下测试：

```bash
# 测试1: 健康检查
curl http://121.43.139.147:5000/health

# 测试2: 版本检查
curl "http://121.43.139.147:5000/version/check?current=25.10.03.04"

# 测试3: 域名访问
curl http://api.shuzhishanmu.com:5000/health
```

---

## 🎯 **操作总结**

1. **第一步**：在宝塔终端运行部署脚本
2. **第二步**：在宝塔面板添加 Node 项目
3. **第三步**：启动项目
4. **第四步**：我验证 API 正常

---

## 🔧 **可能遇到的问题**

### Q1: GitHub 克隆失败？

**错误信息**：`fatal: unable to access 'https://github.com/...'`

**解决方案**：网络问题，重试或者用以下命令：

```bash
# 使用gitee镜像（如果有）
# 或者稍后重试
```

### Q2: npm install 很慢？

**原因**：已经配置了国内镜像，应该比较快
**耐心等待**：通常 3-5 分钟

### Q3: 构建失败？

**常见原因**：依赖安装不完整
**解决方案**：

```bash
cd /www/wwwroot/sm-api-v2
rm -rf node_modules package-lock.json
npm install
npm run build
```

### Q4: 找不到 dist/main.js？

**检查构建输出**：

```bash
cd /www/wwwroot/sm-api-v2
ls -la dist/
```

如果 dist 目录不存在或为空，说明构建失败，需要查看构建错误

### Q5: 启动后又自动停止？

**查看日志**：

1. 在宝塔面板点击项目的"日志"按钮
2. 或者在终端执行：

```bash
pm2 logs sm-api-v2 --lines 50
```

将错误信息截图发给我

---

## 📞 **需要帮助？**

遇到任何问题：

1. 截图错误信息
2. 告诉我在哪一步卡住了
3. 我会立即帮您解决

---

## ✅ **完成标志**

当您看到：

- ✅ 终端显示"部署完成"
- ✅ 宝塔面板项目状态显示"运行中"（绿色）
- ✅ 我的测试全部通过

就说明部署成功了！

然后我会：

1. 修改移动应用 API 地址
2. 构建新 APK
3. 安装到您的测试设备
4. 测试所有功能

---

**准备好了吗？请先点击"取消"关闭当前对话框，然后开始第一步！** 🚀
