# é’‰é’‰ç™»å½•å‰ç«¯è°ƒç”¨æ£€æŸ¥æ¸…å•

## âœ… å·²å®Œæˆçš„æ£€æŸ¥å’Œä¼˜åŒ–

### 1. å‰ç«¯è°ƒç”¨é€»è¾‘æ£€æŸ¥

**æ–‡ä»¶**: `web/src/app/login/page.tsx`

**æ£€æŸ¥ç»“æœ**: âœ… æ­£ç¡®
- âœ… æ­£ç¡®è°ƒç”¨ `dingTalkApi.getAuthUrl('login')`
- âœ… æ­£ç¡®è§£æ `result.url` å­—æ®µ
- âœ… æ­£ç¡®ä½¿ç”¨ `window.location.href = result.url` è·³è½¬
- âœ… å·²æ·»åŠ è¯¦ç»†çš„é”™è¯¯å¤„ç†å’Œè°ƒè¯•æ—¥å¿—

**ä»£ç ä½ç½®**:
```typescript
const result = await dingTalkApi.getAuthUrl('login');
window.location.href = result.url; // âœ… æ­£ç¡®
```

### 2. API æ¥å£å®šä¹‰æ£€æŸ¥

**æ–‡ä»¶**: `web/src/lib/api.ts`

**æ£€æŸ¥ç»“æœ**: âœ… æ­£ç¡®
- âœ… API è·¯å¾„æ­£ç¡®ï¼š`/dingtalk/auth-url`
- âœ… è¿”å›ç±»å‹æ­£ç¡®ï¼š`Promise<{ url: string }>`
- âœ… æ­£ç¡®è§£æå“åº”ï¼š`.then(res => res.data)`

**ä»£ç ä½ç½®**:
```typescript
export const dingTalkApi = {
  getAuthUrl: (state?: string): Promise<{ url: string }> => 
    api.get('/dingtalk/auth-url', { params: { state } }).then(res => res.data),
  // ...
};
```

### 3. åç«¯ CORS é…ç½®æ£€æŸ¥

**æ–‡ä»¶**: `server/src/main.ts`

**æ£€æŸ¥ç»“æœ**: âœ… å·²é…ç½®
- âœ… CORS å·²å¯ç”¨ï¼š`app.enableCors()`
- âœ… å…è®¸æ‰€æœ‰æ¥æºï¼š`origin: true`
- âœ… å…è®¸å‡­è¯ï¼š`credentials: true`
- âœ… å…è®¸çš„æ–¹æ³•ï¼š`GET, POST, PUT, DELETE, OPTIONS` ç­‰
- âœ… å…è®¸çš„å¤´éƒ¨ï¼š`Content-Type, Authorization, x-user-id` ç­‰

**ä»£ç ä½ç½®**:
```typescript
app.enableCors({
  origin: true, // å…è®¸æ‰€æœ‰æ¥æº
  credentials: true,
  methods: ['GET','HEAD','PUT','PATCH','POST','DELETE','OPTIONS'],
  allowedHeaders: ['Content-Type','Authorization','x-user-id','X-Requested-With'],
  exposedHeaders: ['Content-Length','Content-Type'],
});
```

### 4. API ä»£ç†é…ç½®æ£€æŸ¥

**æ–‡ä»¶**: `web/src/app/api/[...path]/route.ts`

**æ£€æŸ¥ç»“æœ**: âœ… æ­£ç¡®
- âœ… æ­£ç¡®ä»£ç† `/api/*` åˆ°åç«¯æœåŠ¡
- âœ… Docker ç¯å¢ƒï¼š`http://api:5000`
- âœ… æœ¬åœ°å¼€å‘ï¼š`http://127.0.0.1:5002`

**æ–‡ä»¶**: `web/next.config.ts`

**æ£€æŸ¥ç»“æœ**: âœ… æ­£ç¡®
- âœ… Next.js rewrites é…ç½®ï¼š`/api/:path*` â†’ `http://127.0.0.1:5002/:path*`

### 5. åç«¯æ¥å£å®ç°æ£€æŸ¥

**æ–‡ä»¶**: `server/src/dingtalk/dingtalk.controller.ts`

**æ£€æŸ¥ç»“æœ**: âœ… æ­£ç¡®
- âœ… è·¯ç”±æ­£ç¡®ï¼š`@Get('auth-url')`
- âœ… è¿”å›æ ¼å¼æ­£ç¡®ï¼š`{ url: string }`
- âœ… å·²æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

## ğŸ” è°ƒè¯•æ­¥éª¤

### æ­¥éª¤ 1: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹ Console æ ‡ç­¾é¡µï¼š

**æ­£å¸¸æƒ…å†µåº”è¯¥çœ‹åˆ°**:
```
[LoginPage] å¼€å§‹è·å–é’‰é’‰æˆæƒURL...
[LoginPage] è·å–åˆ°çš„å“åº”: { url: "https://oapi.dingtalk.com/..." }
[LoginPage] å‡†å¤‡è·³è½¬åˆ°é’‰é’‰æˆæƒé¡µé¢: https://oapi.dingtalk.com/...
```

**å¦‚æœçœ‹åˆ°é”™è¯¯**:
- æ£€æŸ¥é”™è¯¯ä¿¡æ¯
- æŸ¥çœ‹ Network æ ‡ç­¾é¡µä¸­çš„è¯·æ±‚è¯¦æƒ…

### æ­¥éª¤ 2: æ£€æŸ¥ç½‘ç»œè¯·æ±‚

åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„ Network æ ‡ç­¾é¡µä¸­ï¼š

1. **æŸ¥æ‰¾è¯·æ±‚**: `/api/dingtalk/auth-url`
2. **æ£€æŸ¥è¯·æ±‚çŠ¶æ€**:
   - âœ… 200: è¯·æ±‚æˆåŠŸ
   - âŒ 404: æ¥å£è·¯å¾„é”™è¯¯
   - âŒ 500: åç«¯é”™è¯¯
   - âŒ CORS é”™è¯¯: è·¨åŸŸé…ç½®é—®é¢˜

3. **æ£€æŸ¥å“åº”å†…å®¹**:
   ```json
   {
     "url": "https://oapi.dingtalk.com/connect/oauth2/sns_authorize?..."
   }
   ```

### æ­¥éª¤ 3: æ£€æŸ¥åç«¯æ—¥å¿—

æŸ¥çœ‹åç«¯æœåŠ¡æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
[DingTalkController] æ”¶åˆ°è·å–æˆæƒURLè¯·æ±‚ï¼Œstate: login
[DingTalkService] ç”Ÿæˆçš„æˆæƒURL: https://oapi.dingtalk.com/...
[DingTalkController] è¿”å›æˆæƒURLå“åº”: { hasUrl: true, ... }
```

### æ­¥éª¤ 4: ç›´æ¥æµ‹è¯•åç«¯æ¥å£

ä½¿ç”¨ curl æˆ– Postman ç›´æ¥æµ‹è¯•åç«¯æ¥å£ï¼š

```bash
# æµ‹è¯•è·å–æˆæƒURL
curl http://localhost:5002/dingtalk/auth-url?state=login

# åº”è¯¥è¿”å›ï¼š
# {
#   "url": "https://oapi.dingtalk.com/connect/oauth2/sns_authorize?..."
# }
```

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: CORS é”™è¯¯

**é”™è¯¯ä¿¡æ¯**: 
```
Access to XMLHttpRequest at 'http://...' from origin 'http://...' has been blocked by CORS policy
```

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®è®¤åç«¯ CORS å·²å¯ç”¨ï¼ˆâœ… å·²é…ç½®ï¼‰
2. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
3. æ£€æŸ¥å‰ç«¯è¯·æ±‚çš„ URL æ˜¯å¦æ­£ç¡®

### é—®é¢˜ 2: 404 é”™è¯¯

**é”™è¯¯ä¿¡æ¯**: 
```
GET http://localhost:3000/api/dingtalk/auth-url 404 (Not Found)
```

**å¯èƒ½åŸå› **:
1. Next.js API è·¯ç”±æœªæ­£ç¡®é…ç½®
2. åç«¯æœåŠ¡æœªå¯åŠ¨
3. ä»£ç†é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `web/next.config.ts` ä¸­çš„ rewrites é…ç½®
2. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦åœ¨ 5002 ç«¯å£è¿è¡Œ
3. æ£€æŸ¥ `web/src/app/api/[...path]/route.ts` æ˜¯å¦å­˜åœ¨

### é—®é¢˜ 3: å“åº”æ ¼å¼é”™è¯¯

**é”™è¯¯ä¿¡æ¯**: 
```
Cannot read property 'url' of undefined
```

**å¯èƒ½åŸå› **:
1. åç«¯è¿”å›çš„å“åº”æ ¼å¼ä¸æ­£ç¡®
2. API ä»£ç†æœªæ­£ç¡®è½¬å‘å“åº”

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥åç«¯æ§åˆ¶å™¨è¿”å›çš„æ ¼å¼æ˜¯å¦ä¸º `{ url: string }`
2. æ£€æŸ¥ API ä»£ç†æ˜¯å¦æ­£ç¡®è½¬å‘å“åº”
3. æŸ¥çœ‹æµè§ˆå™¨ Network æ ‡ç­¾é¡µä¸­çš„å®é™…å“åº”å†…å®¹

### é—®é¢˜ 4: ç½‘ç»œè¶…æ—¶

**é”™è¯¯ä¿¡æ¯**: 
```
Request timeout
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆå½“å‰ä¸º 10 ç§’ï¼‰

## ğŸ“‹ å®Œæ•´æ£€æŸ¥æ¸…å•

åœ¨æµ‹è¯•é’‰é’‰ç™»å½•åŠŸèƒ½å‰ï¼Œè¯·ç¡®è®¤ï¼š

### å‰ç«¯æ£€æŸ¥
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ— é”™è¯¯
- [ ] Network è¯·æ±‚ `/api/dingtalk/auth-url` è¿”å› 200
- [ ] å“åº”åŒ…å« `url` å­—æ®µ
- [ ] `result.url` ä¸ä¸ºç©º
- [ ] è·³è½¬é€»è¾‘æ­£ç¡®æ‰§è¡Œ

### åç«¯æ£€æŸ¥
- [ ] åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] `/dingtalk/auth-url` æ¥å£å¯è®¿é—®
- [ ] è¿”å›æ ¼å¼ä¸º `{ url: string }`
- [ ] CORS é…ç½®æ­£ç¡®
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®

### ç½‘ç»œæ£€æŸ¥
- [ ] å‰ç«¯å¯ä»¥è®¿é—®åç«¯æ¥å£
- [ ] æ—  CORS é”™è¯¯
- [ ] æ— ç½‘ç»œè¶…æ—¶
- [ ] ä»£ç†é…ç½®æ­£ç¡®

## ğŸ”§ æµ‹è¯•å‘½ä»¤

### æµ‹è¯•åç«¯æ¥å£ï¼ˆç›´æ¥è®¿é—®ï¼‰
```bash
# æœ¬åœ°å¼€å‘ç¯å¢ƒ
curl http://localhost:5002/dingtalk/auth-url?state=login

# Docker ç¯å¢ƒ
curl http://localhost:5000/dingtalk/auth-url?state=login
```

### æµ‹è¯•å‰ç«¯ä»£ç†
```bash
# é€šè¿‡å‰ç«¯ä»£ç†è®¿é—®
curl http://localhost:3000/api/dingtalk/auth-url?state=login
```

### æµ‹è¯•å®Œæ•´æµç¨‹
1. æ‰“å¼€æµè§ˆå™¨ï¼š`http://localhost:3000/login`
2. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
3. ç‚¹å‡»"é’‰é’‰ä¼ä¸šç™»å½•"æŒ‰é’®
4. æŸ¥çœ‹ Console å’Œ Network æ ‡ç­¾é¡µ
5. ç¡®è®¤æ˜¯å¦æ­£å¸¸è·³è½¬åˆ°é’‰é’‰æˆæƒé¡µé¢

## ğŸ“ å·²æ·»åŠ çš„è°ƒè¯•åŠŸèƒ½

### å‰ç«¯è°ƒè¯•æ—¥å¿—
- âœ… è¯·æ±‚å¼€å§‹æ—¥å¿—
- âœ… å“åº”å†…å®¹æ—¥å¿—
- âœ… é”™è¯¯è¯¦æƒ…æ—¥å¿—
- âœ… URL è·³è½¬æ—¥å¿—

### åç«¯è°ƒè¯•æ—¥å¿—
- âœ… è¯·æ±‚æ¥æ”¶æ—¥å¿—
- âœ… æˆæƒ URL ç”Ÿæˆæ—¥å¿—
- âœ… å“åº”è¿”å›æ—¥å¿—
- âœ… é”™è¯¯å¤„ç†æ—¥å¿—

## ğŸ¯ ä¸‹ä¸€æ­¥

å¦‚æœæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼Œä½†ä»ç„¶æ— æ³•è·³è½¬ï¼Œè¯·ï¼š

1. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**ï¼š
   - æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—
   - åç«¯æœåŠ¡æ—¥å¿—
   - Network è¯·æ±‚è¯¦æƒ…

2. **æ£€æŸ¥é’‰é’‰é…ç½®**ï¼š
   - å®‰å…¨åŸŸåæ˜¯å¦å·²æ·»åŠ 
   - å›è°ƒåœ°å€æ˜¯å¦æ­£ç¡®
   - åº”ç”¨æ˜¯å¦å·²å‘å¸ƒ

3. **è”ç³»æŠ€æœ¯æ”¯æŒ**ï¼š
   - æä¾›å®Œæ•´çš„é”™è¯¯æ—¥å¿—
   - æä¾›ç½‘ç»œè¯·æ±‚è¯¦æƒ…
   - æä¾›åç«¯æ—¥å¿—

