services:
  api:
    build:
      context: ./server
      dockerfile: ../Dockerfile.api
    env_file: ./server/.env
    container_name: shumu-api-1
    ports:
      - "5000:5000"
    restart: always
    environment:
      - PORT=5000
      - NODE_ENV=production
    volumes:
      - ./server/prisma:/app/server/prisma
    # Linux 系统需要添加此配置以访问宿主机服务
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://127.0.0.1:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - shumu-network

  web:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - NEXT_PUBLIC_API_BASE=/api
      - NODE_ENV=production
      - API_URL=http://api:5000
    depends_on:
      api:
        condition: service_healthy
    container_name: shumu-web-1
    ports:
      - "3000:3000"
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://127.0.0.1:3000" ] # 检测3000端口根路径
      interval: 30s # 和api保持一致的检查频率
      timeout: 10s # 超时时间对齐
      retries: 5 # 重试次数和api一致（更宽松，避免误判）
      start_period: 60s
    networks:
      - shumu-network

networks:
  shumu-network:
    driver: bridge
