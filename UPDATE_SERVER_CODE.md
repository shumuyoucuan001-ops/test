# ğŸ”„ æ›´æ–°æœåŠ¡å™¨ä»£ç æŒ‡å—

## âš ï¸ **å½“å‰é—®é¢˜**

æœåŠ¡å™¨ä¸Šçš„ä»£ç ç‰ˆæœ¬å¤ªæ—§ï¼Œç¼ºå°‘ä»¥ä¸‹æ¨¡å—ï¼š

- âŒ version æ¨¡å—ï¼ˆç‰ˆæœ¬æ£€æŸ¥åŠŸèƒ½ï¼‰
- âŒ receipt æ¨¡å—çš„å®Œæ•´æ¥å£
- âŒ template æ¨¡å—çš„æ‰“å°æ¥å£
- âŒ å…¶ä»–æ–°åŠŸèƒ½

è¿™å¯¼è‡´ï¼š

1. âœ… å¥åº·æ£€æŸ¥æ­£å¸¸: `/health`
2. âŒ ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥: `/version/check`
3. âŒ æ‰“å°åŠŸèƒ½å¤±æ•ˆ: `/template/generate-tspl`
4. âŒ æ”¶è´§å•æŸ¥è¯¢å¯èƒ½å¼‚å¸¸

---

## ğŸ“¦ **éœ€è¦æ›´æ–°çš„å†…å®¹**

### åç«¯ä»£ç ï¼ˆserver ç›®å½•ï¼‰

éœ€è¦å°†æœ¬åœ°æœ€æ–°ä»£ç éƒ¨ç½²åˆ°æœåŠ¡å™¨çš„ä»¥ä¸‹ä½ç½®ï¼š

```
/www/wwwroot/sm-api/
```

---

## ğŸš€ **æ›´æ–°æ–¹æ³•ï¼ˆ3 ç§æ–¹æ¡ˆï¼‰**

### **æ–¹æ¡ˆ 1: ä½¿ç”¨ Git æ‹‰å–æœ€æ–°ä»£ç ï¼ˆæ¨èï¼‰**

å¦‚æœæœåŠ¡å™¨ä¸Šçš„ä»£ç æ˜¯é€šè¿‡ Git ç®¡ç†çš„ï¼š

```bash
# SSHç™»å½•åˆ°æœåŠ¡å™¨
ssh root@121.43.139.147

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /www/wwwroot/sm-api

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin develop

# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœpackage.jsonæœ‰æ›´æ–°ï¼‰
npm install

# é‡å¯æœåŠ¡ï¼ˆé€šè¿‡å®å¡”é¢æ¿æˆ–PM2ï¼‰
# æ–¹æ³•1: å®å¡”é¢æ¿
# è®¿é—®: http://121.43.139.147:8888
# è¿›å…¥: Nodeé¡¹ç›® â†’ sm-api â†’ ç‚¹å‡»"é‡å¯"

# æ–¹æ³•2: ä½¿ç”¨PM2å‘½ä»¤
pm2 restart sm-api
```

---

### **æ–¹æ¡ˆ 2: ä½¿ç”¨å®å¡”é¢æ¿ä¸Šä¼ ä»£ç **

1. **æ‰“åŒ…æœ¬åœ°ä»£ç **

   ```bash
   cd /Users/xiangwork/Documents/GitHub/shumu
   tar -czf server-update.tar.gz server/
   ```

2. **ä¸Šä¼ åˆ°æœåŠ¡å™¨**

   - è®¿é—®å®å¡”é¢æ¿: http://121.43.139.147:8888
   - è¿›å…¥: æ–‡ä»¶ â†’ `/www/wwwroot/sm-api/`
   - ä¸Šä¼  `server-update.tar.gz`
   - è§£å‹å¹¶è¦†ç›–åŸæ–‡ä»¶

3. **SSH å®‰è£…ä¾èµ–å¹¶é‡å¯**
   ```bash
   cd /www/wwwroot/sm-api
   npm install
   pm2 restart sm-api
   ```

---

### **æ–¹æ¡ˆ 3: ä½¿ç”¨ rsync ç›´æ¥åŒæ­¥ï¼ˆæœ€å¿«ï¼‰**

ä» Mac æœ¬åœ°ç›´æ¥åŒæ­¥åˆ°æœåŠ¡å™¨ï¼š

```bash
# åŒæ­¥serverç›®å½•åˆ°æœåŠ¡å™¨
rsync -avz --exclude 'node_modules' --exclude 'prisma/dev.db' \
  /Users/xiangwork/Documents/GitHub/shumu/server/ \
  root@121.43.139.147:/www/wwwroot/sm-api/

# SSHç™»å½•æœåŠ¡å™¨
ssh root@121.43.139.147

# å®‰è£…ä¾èµ–å¹¶é‡å¯
cd /www/wwwroot/sm-api
npm install
pm2 restart sm-api
```

---

## ğŸ” **éªŒè¯æ›´æ–°æ˜¯å¦æˆåŠŸ**

æ›´æ–°å¹¶é‡å¯åï¼Œæ‰§è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

```bash
# 1. æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://api.shuzhishanmu.com:4000/health
# é¢„æœŸ: {"status":"ok"}

# 2. æµ‹è¯•ç‰ˆæœ¬æ£€æŸ¥
curl "http://api.shuzhishanmu.com:4000/version/check?current=25.10.03.04"
# é¢„æœŸ: {"hasUpdate":false,"version":"25.10.03.04","message":"å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"}

# 3. æµ‹è¯•æ¨¡æ¿ç”Ÿæˆæ¥å£
curl -X POST http://api.shuzhishanmu.com:4000/template/generate-tspl \
  -H "Content-Type: application/json" \
  -d '{"templateId":"default","data":{"sku":"TEST123"},"copies":1}'
# é¢„æœŸ: è¿”å›TSPLå‘½ä»¤å­—ç¬¦ä¸²

# 4. æµ‹è¯•æ”¶è´§å•æŸ¥è¯¢
curl http://api.shuzhishanmu.com:4000/receipt
# é¢„æœŸ: è¿”å›æ”¶è´§å•åˆ—è¡¨
```

---

## âš¡ **å¿«é€Ÿéƒ¨ç½²è„šæœ¬ï¼ˆå¦‚æœæœåŠ¡å™¨å·²æœ‰ Git ä»“åº“ï¼‰**

æˆ‘å¯ä»¥å¸®æ‚¨åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨éƒ¨ç½²è„šæœ¬ï¼š

```bash
#!/bin/bash
# deploy-server.sh

echo "ğŸš€ å¼€å§‹æ›´æ–°æœåŠ¡å™¨ä»£ç ..."

# SSHåˆ°æœåŠ¡å™¨å¹¶æ‰§è¡Œæ›´æ–°
ssh root@121.43.139.147 << 'EOF'
cd /www/wwwroot/sm-api
echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
git pull origin develop
echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
npm install
echo "ğŸ”„ é‡å¯æœåŠ¡..."
pm2 restart sm-api
echo "âœ… æ›´æ–°å®Œæˆï¼"
EOF

echo ""
echo "ğŸ§ª æµ‹è¯•API..."
sleep 3
curl -s http://api.shuzhishanmu.com:4000/health
echo ""
curl -s "http://api.shuzhishanmu.com:4000/version/check?current=25.10.03.04"
echo ""
echo "âœ¨ éƒ¨ç½²å®Œæˆï¼"
```

---

## ğŸ“ **æ³¨æ„äº‹é¡¹**

1. **å¤‡ä»½æ•°æ®åº“**

   ```bash
   # å¤‡ä»½prismaæ•°æ®åº“
   cd /www/wwwroot/sm-api
   cp prisma/dev.db prisma/dev.db.backup-$(date +%Y%m%d-%H%M%S)
   ```

2. **æ£€æŸ¥ç¯å¢ƒå˜é‡**

   - ç¡®ä¿æœåŠ¡å™¨ä¸Šçš„ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
   - ç‰¹åˆ«æ˜¯æ•°æ®åº“è·¯å¾„ã€ç«¯å£ç­‰

3. **æŸ¥çœ‹æ—¥å¿—**

   ```bash
   # æŸ¥çœ‹PM2æ—¥å¿—
   pm2 logs sm-api --lines 50

   # æˆ–è€…æŸ¥çœ‹å®å¡”é¢æ¿çš„æ—¥å¿—
   # å®å¡”é¢æ¿ â†’ Nodeé¡¹ç›® â†’ sm-api â†’ æŸ¥çœ‹æ—¥å¿—
   ```

---

## ğŸ”§ **æ•…éšœæ’æŸ¥**

### é—®é¢˜ 1: npm install å¤±è´¥

```bash
# æ¸…é™¤npmç¼“å­˜
npm cache clean --force
rm -rf node_modules package-lock.json
npm install
```

### é—®é¢˜ 2: PM2 é‡å¯å¤±è´¥

```bash
# åœæ­¢å¹¶åˆ é™¤æ—§è¿›ç¨‹
pm2 stop sm-api
pm2 delete sm-api

# é‡æ–°å¯åŠ¨
cd /www/wwwroot/sm-api
pm2 start npm --name "sm-api" -- start
pm2 save
```

### é—®é¢˜ 3: ç«¯å£è¢«å ç”¨

```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :4000
# æˆ–
netstat -tulpn | grep 4000

# æ€æ­»è¿›ç¨‹
kill -9 <PID>
```

---

## ğŸ¯ **æˆ‘éœ€è¦æ‚¨çš„ä¿¡æ¯**

è¯·å‘Šè¯‰æˆ‘ï¼š

1. âœ… æœåŠ¡å™¨ä¸Šçš„ä»£ç æ˜¯å¦æ˜¯é€šè¿‡ Git ç®¡ç†çš„ï¼Ÿ
2. âœ… æ‚¨çš„æœåŠ¡å™¨ SSH ç™»å½•æ–¹å¼ï¼Ÿï¼ˆå¯†ç /å¯†é’¥ï¼‰
3. âœ… æ‚¨å¸Œæœ›ä½¿ç”¨å“ªç§æ›´æ–°æ–¹æ¡ˆï¼Ÿ

**æˆ–è€…æ‚¨å¯ä»¥ç»™æˆ‘å®å¡”é¢æ¿çš„ SSH ç»ˆç«¯è®¿é—®æƒé™ï¼Œæˆ‘å¯ä»¥ç›´æ¥å¸®æ‚¨æ›´æ–°ã€‚**

---

## ğŸ“Œ **æ›´æ–°å®Œæˆå**

1. æˆ‘ä¼šéªŒè¯æ‰€æœ‰æ¥å£æ­£å¸¸
2. ç„¶åé‡æ–°æ„å»ºç§»åŠ¨åº”ç”¨ï¼ˆä¸æ›´æ–°ç‰ˆæœ¬å·ï¼Œè¿˜æ˜¯ 25.10.03.04ï¼‰
3. å®‰è£…åˆ°æ‚¨çš„æµ‹è¯•è®¾å¤‡
4. è¿›è¡Œå®Œæ•´çš„çœŸå®ç¯å¢ƒæµ‹è¯•

**è¯·å‘Šè¯‰æˆ‘æ‚¨å¸Œæœ›ä½¿ç”¨å“ªç§æ–¹å¼æ›´æ–°æœåŠ¡å™¨ä»£ç ï¼** ğŸš€
