# 钉钉应用配置检查清单

## ❌ 当前问题

从日志可以看到：
- `window.dd` 一直不存在
- JSAPI脚本已加载，但 `window.dd` 仍未初始化
- 钉钉客户端没有自动注入JSAPI

**这通常是钉钉应用配置问题！**

## 🔍 钉钉应用配置检查

### 1. 应用类型确认 ⭐ 最重要

**必须确认**：应用类型是 **"企业内部开发" → "H5微应用"**

**检查步骤**：
1. 登录钉钉开放平台：https://open.dingtalk.com/
2. 进入：应用开发 → **企业内部开发** → **H5微应用**
3. 确认应用类型正确

**常见错误**：
- ❌ 使用了"第三方应用"（不支持免登）
- ❌ 使用了"小程序"（不是H5微应用）
- ✅ 正确：**企业内部开发** → **H5微应用**

### 2. 应用状态检查 ⭐ 最重要

**应用必须已发布上线！**

**检查步骤**：
1. 进入应用详情页面
2. 查看应用状态
3. **必须显示"已发布"或"已上线"**

**如果未发布**：
- 点击"发布"按钮
- 填写发布信息
- 等待审核通过（通常几分钟）

**注意**：未发布的应用无法使用JSAPI！

### 3. 应用首页地址配置 ⭐ 最重要

**位置**：应用详情 → 基本信息 → **应用首页地址**

**必须配置为**：
```
http://47.106.87.166
```

**配置要求**：
- ✅ 必须是完整URL（包含协议）
- ✅ 必须与您实际访问的地址一致
- ✅ 如果使用HTTPS，必须配置为 `https://47.106.87.166`

**常见错误**：
- ❌ 配置为 `47.106.87.166`（缺少协议）
- ❌ 配置为 `http://47.106.87.166/login`（路径错误，应该是根路径）
- ❌ 配置为其他地址

### 4. 安全域名配置

**位置**：应用详情 → 开发管理 → **安全域名**

**配置要求**：
- 如果配置了，应该是：`47.106.87.166`（仅域名）
- 对于免登方式，安全域名**不是必需的**，但建议配置

### 5. 权限管理检查

**位置**：应用详情 → 权限管理

**必须申请的权限**：
- ✅ **通讯录权限** - 获取用户信息
- ✅ **身份验证权限** - 免登授权

**检查步骤**：
1. 进入权限管理
2. 查看已申请的权限
3. 确认权限状态为"已授权"

### 6. 应用AgentId检查

**位置**：应用详情 → 基本信息 → AgentId

**注意**：某些版本的钉钉可能需要AgentId，但免登主要使用CorpId。

## 🔧 配置验证步骤

### 步骤1: 完整配置检查

在钉钉开放平台，逐一确认：

- [ ] **应用类型**：企业内部开发 → H5微应用
- [ ] **应用状态**：已发布/已上线
- [ ] **应用首页地址**：`http://47.106.87.166`（完整URL）
- [ ] **安全域名**：`47.106.87.166`（可选，但建议配置）
- [ ] **权限管理**：通讯录权限、身份验证权限已授权

### 步骤2: 测试应用访问

1. **在钉钉客户端内打开应用**
   - 打开钉钉PC客户端或移动客户端
   - 在工作台中找到您的应用
   - 点击打开应用

2. **检查URL**
   - 应用应该打开 `http://47.106.87.166`
   - URL应该与应用首页地址配置一致

3. **检查JSAPI注入**
   - 打开调试面板
   - 查看是否有 `✅ 钉钉JSAPI已自动注入` 的日志

### 步骤3: 如果JSAPI仍未注入

如果配置都正确，但JSAPI仍未注入，可能的原因：

1. **应用未发布**（最常见）
   - 解决：发布应用并等待生效

2. **应用首页地址不匹配**
   - 解决：确保配置的地址与访问地址完全一致

3. **钉钉客户端版本问题**
   - 解决：更新钉钉客户端到最新版本

4. **需要等待配置生效**
   - 解决：配置修改后等待5-10分钟

## 📋 完整检查清单

### 钉钉开放平台配置

- [ ] 应用类型：**企业内部开发** → **H5微应用**
- [ ] 应用状态：**已发布/已上线** ⭐
- [ ] 应用首页地址：`http://47.106.87.166`（完整URL）⭐
- [ ] 安全域名：`47.106.87.166`（可选）
- [ ] 权限管理：通讯录权限、身份验证权限已授权

### 后端环境变量

- [ ] `DINGTALK_APP_KEY` 已配置
- [ ] `DINGTALK_APP_SECRET` 已配置
- [ ] `DINGTALK_CORP_ID` 已配置

### 测试验证

- [ ] 在钉钉客户端内打开应用
- [ ] 应用能正常打开（不报错）
- [ ] 调试面板显示JSAPI已注入

## 🎯 重点检查项

根据您的日志，**最可能的问题是**：

1. **应用未发布** ⭐⭐⭐
   - 这是最常见的原因
   - 未发布的应用无法使用JSAPI

2. **应用首页地址配置错误** ⭐⭐
   - 必须配置为 `http://47.106.87.166`
   - 必须与访问地址完全一致

3. **应用类型错误** ⭐
   - 必须是"企业内部开发" → "H5微应用"
   - 不能是"第三方应用"

## 🔧 快速修复

### 如果应用未发布：

1. 登录钉钉开放平台
2. 进入应用详情
3. 点击"发布"按钮
4. 填写发布信息
5. 等待审核通过（通常几分钟）
6. 刷新应用页面测试

### 如果应用首页地址错误：

1. 进入应用详情 → 基本信息
2. 修改"应用首页地址"为：`http://47.106.87.166`
3. 保存配置
4. 等待几分钟让配置生效
5. 在钉钉客户端内重新打开应用

## ❓ 常见问题

### Q1: 应用发布需要多长时间？

**A**: 通常几分钟内就能审核通过。如果是企业内部应用，审核会更快。

### Q2: 修改配置后多久生效？

**A**: 通常立即生效，但建议等待5-10分钟后再测试。

### Q3: 如何确认应用已发布？

**A**: 在应用详情页面，应用状态应该显示"已发布"或"已上线"，而不是"开发中"或"未发布"。

### Q4: 应用首页地址可以配置路径吗？

**A**: 对于免登方式，建议配置为根路径（如 `http://47.106.87.166`），不要包含 `/login` 等路径。

## 📝 验证方法

配置完成后，在钉钉客户端内打开应用，调试面板应该显示：

```
[SUCCESS] ✅ 钉钉JSAPI已自动注入
```

如果还是显示 `window.dd不存在`，请检查：
1. 应用是否已发布
2. 应用首页地址是否正确
3. 是否在钉钉客户端内打开（不是在浏览器）


