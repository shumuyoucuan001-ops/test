# 🚀 宝塔面板部署配置指南

## 📋 服务器信息

- **公网IP**: 121.43.139.147
- **操作系统**: Alibaba Cloud Linux 3.2104 LTS 64位
- **管理工具**: 宝塔面板
- **域名**: shuzhishanmu.com
- **已部署项目**:
  - sm-api (后端) - 端口 4000
  - sm-web (前端) - 端口 3000

---

## 🔧 第1步: 配置阿里云安全组（重要！）

### 1.1 登录阿里云ECS控制台
```
https://ecs.console.aliyun.com/
```

### 1.2 添加安全组规则

进入您的ECS实例 → 安全组 → 配置规则 → 入方向 → 添加规则

**需要添加的规则**:

| 协议类型 | 端口范围 | 授权对象 | 优先级 | 描述 |
|---------|---------|---------|--------|------|
| 自定义TCP | 4000 | 0.0.0.0/0 | 1 | 后端API端口 |
| 自定义TCP | 3000 | 0.0.0.0/0 | 1 | 前端Web端口(可选) |
| 自定义TCP | 8888 | 您的IP | 1 | 宝塔面板(如未开放) |

**重要**: 
- 0.0.0.0/0 表示允许所有IP访问
- 宝塔面板端口(8888)建议只对您的IP开放

---

## 🔧 第2步: 配置宝塔面板防火墙

### 2.1 登录宝塔面板
```
http://121.43.139.147:8888
```

### 2.2 放行端口

进入：安全 → 防火墙 → 添加规则

**添加以下端口**:
```
端口: 4000
说明: sm-api后端服务
```

**查看当前Node项目状态**:
进入：网站 → Node项目 → 查看 sm-api 和 sm-web 的运行状态

---

## 🌐 第3步: 配置域名解析

### 3.1 登录阿里云DNS控制台
```
https://dns.console.aliyun.com/
```

### 3.2 为 shuzhishanmu.com 添加解析记录

**记录1: API服务**
```
记录类型: A
主机记录: api
记录值: 121.43.139.147
TTL: 600
线路类型: 默认
```

**记录2: 前端管理（可选）**
```
记录类型: A
主机记录: app
记录值: 121.43.139.147
TTL: 600
线路类型: 默认
```

### 3.3 等待DNS生效

通常需要 5-10 分钟，可以通过以下命令测试：

```bash
# 在本地Mac终端测试
nslookup api.shuzhishanmu.com
```

---

## 🧪 第4步: 测试API访问

### 4.1 测试公网IP访问
```bash
# 测试健康检查接口
curl http://121.43.139.147:4000/health

# 应该返回: {"status":"ok"} 或类似内容
```

### 4.2 测试域名访问（DNS生效后）
```bash
# 测试健康检查接口
curl http://api.shuzhishanmu.com:4000/health

# 测试版本接口
curl http://api.shuzhishanmu.com:4000/version/latest
```

---

## 📱 第5步: 修改移动应用API地址

### 5.1 修改 API 配置文件

**文件**: `SmLabelAppRN/src/api.ts`

**修改前**:
```typescript
const API_BASE_URL = 'http://192.168.0.109:4000';
```

**修改后**（选择其中一种）:

**选项1: 使用公网IP**
```typescript
const API_BASE_URL = 'http://121.43.139.147:4000';
```

**选项2: 使用域名（推荐）**
```typescript
const API_BASE_URL = 'http://api.shuzhishanmu.com:4000';
```

### 5.2 构建新版本APK

版本号: 25.10.03.04

---

## 📝 第6步: 完整操作流程

### 6.1 配置安全组和防火墙
```
1. 阿里云ECS安全组 → 添加4000端口入方向规则
2. 宝塔面板 → 安全 → 防火墙 → 放行4000端口
3. 等待1-2分钟使规则生效
```

### 6.2 验证API可访问
```bash
# 从外网测试（在您的Mac上执行）
curl http://121.43.139.147:4000/health
```

### 6.3 配置域名（可选但推荐）
```
1. 阿里云DNS → 添加 api.shuzhishanmu.com A记录
2. 等待5-10分钟DNS生效
3. 测试: curl http://api.shuzhishanmu.com:4000/health
```

### 6.4 更新移动应用
```
1. 修改 SmLabelAppRN/src/api.ts 中的 API_BASE_URL
2. 构建新版本APK (25.10.03.04)
3. 上传到OSS
4. 通知用户更新
```

---

## 🔍 故障排查

### 问题1: curl 连接失败
**症状**: `curl: (7) Failed to connect`

**解决方案**:
1. 检查阿里云安全组是否放行4000端口
2. 检查宝塔面板防火墙是否放行4000端口
3. 检查Node项目是否正在运行（宝塔面板 → Node项目）
4. 检查项目是否监听 0.0.0.0 而不是 127.0.0.1

### 问题2: 域名无法解析
**症状**: `nslookup: can't find api.shuzhishanmu.com`

**解决方案**:
1. 确认已添加DNS解析记录
2. 等待5-10分钟DNS生效
3. 清除本地DNS缓存: `sudo dscacheutil -flushcache` (Mac)

### 问题3: 宝塔面板中Node项目停止运行
**解决方案**:
1. 查看项目日志
2. 检查端口是否被占用
3. 重启项目
4. 检查环境变量配置

---

## 📋 检查清单

配置前:
- [ ] 记录当前服务器配置（防止误操作）
- [ ] 确认宝塔面板可以正常访问
- [ ] 确认 sm-api 项目正在运行

配置安全组:
- [ ] 阿里云ECS安全组已添加4000端口规则
- [ ] 宝塔面板防火墙已放行4000端口
- [ ] 等待1-2分钟规则生效

测试访问:
- [ ] 可以通过IP访问: `curl http://121.43.139.147:4000/health`
- [ ] 返回正确的响应内容

配置域名:
- [ ] 已添加DNS A记录: api.shuzhishanmu.com → 121.43.139.147
- [ ] DNS解析测试通过: `nslookup api.shuzhishanmu.com`
- [ ] 可以通过域名访问: `curl http://api.shuzhishanmu.com:4000/health`

更新应用:
- [ ] 已修改 SmLabelAppRN/src/api.ts
- [ ] 已构建新版本APK (25.10.03.04)
- [ ] 已上传APK到OSS
- [ ] 已更新后端版本号

---

## 🎯 推荐配置

**最终访问地址**:
- 移动应用API: `http://api.shuzhishanmu.com:4000`
- 前端管理系统: `http://app.shuzhishanmu.com:3000`
- APK下载: `http://download.shuzhishanmu.com/app/android/app-release.apk`

**优点**:
- 使用域名更专业、易记
- 后期可以升级到HTTPS
- 便于维护和管理

---

## 📞 下一步操作

1. **配置阿里云安全组** - 开放4000端口
2. **配置宝塔面板防火墙** - 放行4000端口
3. **测试API访问** - 确认可以从外网访问
4. **配置DNS解析** - 绑定 api.shuzhishanmu.com
5. **修改移动应用** - 更新API地址
6. **构建新版本** - 版本号 25.10.03.04

**请按照上述步骤完成配置，完成后告诉我测试结果！**

---

## 💡 提示

- 宝塔面板的Node项目管理非常方便，可以直接查看日志和重启服务
- 建议先用IP测试，确认可用后再配置域名
- 配置过程不会影响现有的前后端服务
- 如有问题，可以随时在宝塔面板中重启项目

