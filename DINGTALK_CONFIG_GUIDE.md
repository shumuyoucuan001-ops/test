# 钉钉开放平台配置详细指南

## 📍 钉钉回调地址配置位置

### 方法1：企业内应用（H5微应用）

1. **登录钉钉开放平台**
   - 访问：https://open.dingtalk.com/
   - 使用企业管理员账号登录

2. **进入应用管理**
   - 点击顶部菜单"应用开发"
   - 选择"企业内部开发"
   - 选择"H5微应用"
   - 找到您的应用，点击进入

3. **配置回调地址（重要！）**
   - 在应用详情页面，找到"开发管理"或"基本信息"标签
   - 找到"OAuth2.0回调地址"或"回调URL"配置项
   - **如果找不到，请查看"登录与分享"或"安全设置"标签**
   - 添加回调地址：`http://shuzhishanmu.com/login` 或 `https://shuzhishanmu.com/login`

4. **配置安全域名**
   - 在"开发管理"或"安全设置"中，找到"安全域名"或"可信域名"
   - 添加域名：`shuzhishanmu.com`（不需要协议和路径）
   - 如果使用IP地址，也需要添加IP地址

### 方法2：如果找不到回调地址配置

**可能的原因：**
1. 应用类型不对（需要使用"企业内应用"而不是"第三方应用"）
2. 应用未发布上线
3. 权限不足（需要企业管理员权限）

**解决步骤：**
1. 确认应用类型是"企业内部开发" -> "H5微应用"
2. 在应用详情页面，查看所有标签页：
   - 基本信息
   - 开发管理
   - 登录与分享
   - 安全设置
   - 权限管理
3. 如果确实找不到，可能需要：
   - 重新创建应用
   - 或者使用"扫码登录"方式（需要不同的配置）

---

## 🔧 完整配置步骤

### 步骤1：创建/选择应用

1. 登录钉钉开放平台
2. 应用开发 -> 企业内部开发 -> H5微应用
3. 创建新应用或选择已有应用

### 步骤2：获取应用信息

在应用详情页面的"基本信息"中，记录：
- **AppKey**（应用Key）
- **AppSecret**（应用密钥，点击"查看"按钮显示）
- **CorpId**（企业ID，在企业信息中查看）

### 步骤3：配置回调地址

**位置1：OAuth2.0回调地址**
- 位置：应用详情 -> 开发管理 -> OAuth2.0回调地址
- 配置：`http://shuzhishanmu.com/login` 或 `https://shuzhishanmu.com/login`
- ⚠️ **必须与 `server/.env` 中的 `DINGTALK_REDIRECT_URI` 完全一致**

**位置2：安全域名**
- 位置：应用详情 -> 开发管理 -> 安全域名
- 配置：`shuzhishanmu.com`（不需要协议和路径）

### 步骤4：申请权限

在"权限管理"中，申请以下权限：
- ✅ 获取用户基本信息
- ✅ 获取用户手机号（如果需要）

### 步骤5：发布应用

1. 确保应用配置完整
2. 点击"发布"按钮
3. 等待审核通过（通常很快）

---

## 🎯 钉钉开放平台界面说明

### 应用详情页面结构

```
应用详情
├── 基本信息
│   ├── 应用名称
│   ├── AppKey
│   ├── AppSecret
│   └── 企业ID (CorpId)
│
├── 开发管理
│   ├── OAuth2.0回调地址 ⭐ 在这里配置
│   ├── 安全域名 ⭐ 在这里配置
│   └── 服务器出口IP
│
├── 登录与分享
│   └── 可能也有回调地址配置
│
├── 安全设置
│   └── 可信域名/安全域名
│
└── 权限管理
    └── API权限申请
```

---

## ⚠️ 常见问题

### Q1: 找不到"OAuth2.0回调地址"配置项？

**A**: 可能的原因：
1. 应用类型不对（需要使用"企业内应用"）
2. 应用未发布
3. 界面版本不同（钉钉会更新界面）

**解决方法：**
- 查看"开发管理"标签下的所有选项
- 查看"登录与分享"标签
- 查看"安全设置"标签
- 如果还是找不到，尝试重新创建应用

### Q2: 回调地址应该填什么？

**A**: 
- 格式：`http://域名/login` 或 `https://域名/login`
- 示例：`http://shuzhishanmu.com/login`
- ⚠️ **不要包含 `/callback` 路径**
- ⚠️ **必须与 `server/.env` 中的 `DINGTALK_REDIRECT_URI` 完全一致**

### Q3: 安全域名应该填什么？

**A**:
- 只填域名，不需要协议和路径
- 示例：`shuzhishanmu.com`
- 如果使用IP地址，也需要添加IP地址

### Q4: 配置后还是报错？

**A**: 检查以下几点：
1. ✅ 回调地址是否完全一致（包括协议）
2. ✅ 安全域名是否已添加
3. ✅ 应用是否已发布上线
4. ✅ 权限是否已申请并授权
5. ✅ 后端服务是否已重启（使环境变量生效）

---

## 📸 配置截图位置参考

由于钉钉界面可能会更新，以下是常见的配置位置：

1. **OAuth2.0回调地址**
   - 位置：应用详情 -> 开发管理 -> OAuth2.0回调地址
   - 或：应用详情 -> 登录与分享 -> 回调地址

2. **安全域名**
   - 位置：应用详情 -> 开发管理 -> 安全域名
   - 或：应用详情 -> 安全设置 -> 可信域名

---

## 🔍 验证配置

### 1. 检查后端配置

访问后端接口查看配置：
```bash
curl http://your-backend-url/dingtalk/auth-url
```

应该返回授权URL和配置信息。

### 2. 检查钉钉开放平台

在钉钉开放平台：
1. 查看回调地址是否已保存
2. 查看安全域名是否已添加
3. 查看应用状态是否为"已发布"

### 3. 测试登录流程

1. 点击"钉钉企业登录"按钮
2. 应该跳转到钉钉授权页面
3. 授权后应该回调到登录页面，URL中包含 `code` 参数

---

## 📞 获取帮助

如果以上步骤都无法解决问题：

1. **查看钉钉开放平台文档**
   - https://open.dingtalk.com/document/
   - 搜索"OAuth2.0"或"回调地址"

2. **联系钉钉技术支持**
   - 在钉钉开放平台找到"技术支持"入口
   - 或拨打钉钉客服电话

3. **检查应用日志**
   - 在钉钉开放平台查看应用日志
   - 查看后端服务日志（已添加详细日志）

